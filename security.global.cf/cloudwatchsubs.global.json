{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "AWSCloudWatch Subscription filters",
  "Parameters" : {
      "LogGroupName" : {
          "Type" : "String",
          "Default" : "CloudTrail/DefaultLogGroup",
          "Description" : "Enter CloudWatch Logs log group name. Default is CloudTrail/DefaultLogGroup"
      },
      "Environment" : {
        "Description": "Environment to deploy. You can specify staging or prod or dev",
        "Type": "String",
        "MinLength" : "2",
        "MaxLength" : "50"
      }
  },
  "Mappings" : {
    "Enviroments" : {
      "regions" : { "staging": "us-east-1",  "prod" : "us-east-1", "dev": "us-east-1", "dr": "us-east-1" },
      "LogCriticalLambdaCodeVer" : { "staging": "yours3bucketobjectversion",  "prod" : "yours3bucketobjectversion", "dev": "yours3bucketobjectversion", "dr": "yours3bucketobjectversion" }
    },
    "FilterMap" : {
      "rds-change" : { "all": "($.eventName = CopyDB* || $.eventName = CreateDB* || $.eventName = DeleteDB*)"},
      "iam-change" : { "all": "(($.eventSource = iam.amazonaws.com) && ($.eventName != Get* && $.eventName != List*))"},
      "srt-instance" : { "all": "(($.eventName = StopInstances || $.eventName = TerminateInstances || $.eventName = RebootInstances))"},
      "large-instance" : { "all": "((($.eventName = RunInstances) || ($.eventName = StartInstances)) && (($.requestParameters.instanceType = *.2xlarge) || ($.requestParameters.instanceType = *.4xlarge) || ($.requestParameters.instanceType = *.8xlarge) || ($.requestParameters.instanceType = *.10xlarge)))"},
      "massive-operations" : { "all": "(($.eventName = StopInstances || $.eventName = TerminateInstances || $.eventName = RebootInstances || $.eventName = RunInstances || $.eventName = StartInstances))"},
      "massive-terminations" : { "all": "($.eventName = TerminateInstances)"},
      "detach-force-ebs" : { "all": "($.eventName = DetachVolume && $.requestParameters.force IS TRUE)"},
      "change-critical-ebs" : { "prod": "(($.eventName = DetachVolume || $.eventName = AttachVolume || $.eventName = CreateVolume || $.eventName = DeleteVolume || $.eventName = EnableVolumeIO || $.eventName = ImportVolume || $.eventName = ModifyVolumeAttribute) && ($.requestParameters.volumeId = vol-volumeID || $.requestParameters.volume1ID = vol-volume2ID))"},
      "change-secgroup" : { "all": "($.eventName = AuthorizeSecurityGroupEgress || $.eventName = AuthorizeSecurityGroupIngress || $.eventName = AuthorizeCacheSecurityGroupIngress || $.eventName = AuthorizeClusterSecurityGroupIngress || $.eventName = AuthorizeDBSecurityGroupIngress ||$.eventName = RevokeSecurityGroupEgress || $.eventName = RevokeSecurityGroupIngress || $.eventName = RevokeCacheSecurityGroupIngress || $.eventName = RevokeClusterSecurityGroupIngress || $.eventName = RevokeDBSecurityGroupIngress)"},
      "create-delete-secgroup" : { "all": "($.eventName = CreateSecurityGroup || $.eventName = CreateCacheSecurityGroup || $.eventName = CreateClusterSecurityGroup || $.eventName = CreateDBSecurityGroup || $.eventName = DeleteSecurityGroup || $.eventName = DeleteCacheSecurityGroup || $.eventName = DeleteClusterSecurityGroup ||  $.eventName = DeleteDBSecurityGroup)"},
      "secgroup-instance" : { "all": "($.eventName = ModifyInstanceAttribute && $.requestParameters.groupSet.items[0].groupId = * )"},
      "route-change" : { "all": "($.eventName = AssociateRouteTable || $.eventName = CreateRouteTable || $.eventName = DeleteRouteTable || $.eventName = DisassociateRouteTable || $.eventName = ReplaceRouteTableAssociation)"},
      "create-delete-vpc" : { "all": "($.eventName = CreateVpc || $.eventName = DeleteVpc)"},
      "netacl-change" : { "all": "(($.eventName = CreateNetworkAcl) || ($.eventName = CreateNetworkAclEntry) || ($.eventName = DeleteNetworkAcl) || ($.eventName = DeleteNetworkAclEntry) || ($.eventName = ReplaceNetworkAclEntry) || ($.eventName = ReplaceNetworkAclAssociation))"},
      "cloudtrail-change" : { "all": "($.eventSource = cloudtrail.amazonaws.com && ($.eventName != Get* && $.eventName != List* && $.eventName != Lookup* && $.eventName != Describe*))"},
      "cloudformation-change" : { "all": "($.eventSource = cloudformation.amazonaws.com && ($.eventName != Validate* && $.eventName != Describe* && $.eventName != List* && $.eventName != Get*))"},
      "root-access" : { "all": "($.userIdentity.type = Root)"},
      "unauthorised" : {"all": "(($.eventName = ConsoleLogin && $.errorMessage = Failed*) || $.errorCode = *UnauthorizedOperation || $.errorCode = AccessDenied*)"},
      "igw-change" : { "all": "($.eventName = AttachInternetGateway || $.eventName = CreateInternetGateway || $.eventName = DeleteInternetGateway || $.eventName = DetachInternetGateway || $.eventName = AttachVpnGateway || $.eventName = CreateVpnGateway || $.eventName = DeleteVpnGateway || $.eventName = DetachVpnGateway)"},
      "vpc-flow-logs" : { "all": "($.eventName = CreateFlowLogs || $.eventName = DeleteFlowLogs)"},
      "critical-instance" : { "prod": "($.requestParameters.instanceId = i-instance1ID || $.requestParameters.instanceId = i-instance2ID || $.requestParameters.instanceId = i-instance3ID || $.requestParameters.instanceId = i-instance4ID )"},
      "eip-change" : { "all": "($.eventName = AssociateAddress || $.eventName = DisassociateAddress || $.eventName = MoveAddressToVpc || $.eventName = ReleaseAddress )"},
      "net-access" : { "all": "($.sourceIPAddress != 111.222.3* && $.sourceIPAddress != 111.222.4* && $.sourceIPAddress != cloud* && $.sourceIPAddress != AWS* && $.sourceIPAddress != 11.22.33.00 && $.sourceIPAddress != 11.22.33.01 )"},
      "test-change" : { "all": "value" },
      "test-change" : { "staging": "value",  "prod" : "value", "dev": "value" }
    }
  },
  "Resources" : {
      "LogCriticalLambda": {
      "Type": "AWS::Lambda::Function",
      "DependsOn": "LogCriticalLambdaRole",
      "Properties": {
         "Handler": "LogCritical_lambda_security_global.lambda_handler",
         "Role": { "Fn::GetAtt" : ["LogCriticalLambdaRole", "Arn"] },
         "Code": {
           "S3Bucket": { "Fn::Join" : ["", ["com.ChangeMe.", {"Ref": "Environment"} , ".cloudform" ]]},
           "S3Key": "LogCritical_lambda_security_global.zip",
           "S3ObjectVersion": { "Fn::FindInMap" : [ "Enviroments", "LogCriticalLambdaCodeVer", {"Ref": "Environment"}]}
                  },
         "Runtime": "python2.7",
         "Timeout": "25"
  }
},
      "LogCriticalLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
         "AssumeRolePolicyDocument": {
           "Version" : "2012-10-17",
                  "Statement": [ {
                     "Effect": "Allow",
                     "Principal": {
                        "Service": [ "lambda.amazonaws.com" ]
                     },
                     "Action": [ "sts:AssumeRole" ]
                  } ]
      },
         "Path": "/infosec/services/",
         "Policies" : [{ "PolicyName": "LogCriticalLambda", "PolicyDocument": {
           "Version": "2012-10-17",
           "Statement": [
             {
               "Sid": "LogCriticalLambda2016",
               "Effect": "Allow",
               "Action": [
                          "sns:Publish",
                          "logs:CreateLogGroup",
                          "logs:CreateLogStream",
                          "logs:PutLogEvents"
                        ],
              "Resource": "*"

             }  ]
           }}]
      }
      },
      "LogCriticalLambdaInvokePermission": {
      "Type": "AWS::Lambda::Permission",
      "DependsOn" : "LogCriticalLambda",
      "Properties": {
          "FunctionName" : { "Fn::GetAtt" : ["LogCriticalLambda", "Arn"] },
          "Action": "lambda:InvokeFunction",
          "Principal": { "Fn::Join" : ["", ["logs.", { "Fn::FindInMap" : [ "Enviroments", "regions", {"Ref": "Environment"}]}, ".amazonaws.com" ]]},
          "SourceAccount": { "Ref" : "AWS::AccountId" }
          }
        },


      "CriticalChangesSubscriptionFilter": {
        "Type": "AWS::Logs::SubscriptionFilter",
        "DependsOn": [ "LogCriticalLambda", "LogCriticalLambdaRole", "LogCriticalLambdaInvokePermission" ],
        "Properties": {
          "LogGroupName": { "Ref": "LogGroupName"},
          "FilterPattern":  { "Fn::Join" : ["", [ "{",
            { "Fn::FindInMap" : [ "FilterMap", "critical-instance", "prod"]},
            " || ",
            { "Fn::FindInMap" : [ "FilterMap", "iam-change", "all"]},
            " || ",
            { "Fn::FindInMap" : [ "FilterMap", "srt-instance", "all"]},
            " || ",
            { "Fn::FindInMap" : [ "FilterMap", "cloudtrail-change", "all"]},
            " || ",
            { "Fn::FindInMap" : [ "FilterMap", "root-access", "all"]},
            " || ",
            { "Fn::FindInMap" : [ "FilterMap", "net-access", "all"]},
            " || ",
            { "Fn::FindInMap" : [ "FilterMap", "detach-force-ebs", "all"]},
            " || ",
            { "Fn::FindInMap" : [ "FilterMap", "unauthorised", "all"]},
            "}"  ]]},
          "DestinationArn": {"Fn::GetAtt" : ["LogCriticalLambda", "Arn"]}
        }
      }



	}
}
