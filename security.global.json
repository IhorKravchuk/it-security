{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Enabling and configuring Global AWS Secutiy settings",
  "Parameters" : {
    "EnvironmentName" : {
      "Description": "Environment to deploy. You can specify staging or prod or dev",
      "Default": "staging",
      "Type": "String",
      "AllowedValues" : ["prod",  "staging", "dev", "dr"]
    }
  },
  "Resources": {
    "CloudTrailGlobal": {
        "Type": "AWS::CloudFormation::Stack",
        "Properties": {
            "TemplateURL":  { "Fn::Join" : ["", ["https://s3.amazonaws.com/com.ChangeMe.", {"Ref": "EnvironmentName"} , ".cloudform/cloudtrail.global.json" ]]},
            "Parameters": {
               "cloudtrailBucketName" : { "Fn::Join" : ["", ["com.ChangeMe.", {"Ref": "EnvironmentName"} , ".infosec.cloudtrail" ]]}
            },
            "TimeoutInMinutes": "60"
        }
    },
    "AWSConfigGlobal": {
        "Type": "AWS::CloudFormation::Stack",
        "Properties": {
            "TemplateURL":  { "Fn::Join" : ["", ["https://s3.amazonaws.com/com.ChangeMe.", {"Ref": "EnvironmentName"} , ".cloudform/awsconfig.global.json" ]]},
            "Parameters": {
               "AWSConfigBucketName" : { "Fn::Join" : ["", ["com.ChangeMe.", {"Ref": "EnvironmentName"} , ".infosec.awsconfig" ]]}
            },
            "TimeoutInMinutes": "60"
        }
    },
    "CloudWarchAlarms": {
        "Type": "AWS::CloudFormation::Stack",
        "Properties": {
            "TemplateURL": { "Fn::Join" : ["", ["https://s3.amazonaws.com/com.ChangeMe.", {"Ref": "EnvironmentName"} , ".cloudform/cloudtrailalarms.global.json" ]]},
            "Parameters": {
               "LogGroupName" : { "Fn::GetAtt" : [ "CloudTrailGlobal", "Outputs.CloudWatchLogsLogGroup" ] },
               "Environment" :  {"Ref": "EnvironmentName"}
            },
            "TimeoutInMinutes": "60"
        }
    },
    "CloudWarchSubscriptions": {
        "Type": "AWS::CloudFormation::Stack",
        "Properties": {
            "TemplateURL": { "Fn::Join" : ["", ["https://s3.amazonaws.com/com.ChangeMe.", {"Ref": "EnvironmentName"} , ".cloudform/cloudwatchsubs.global.json" ]]},
            "Parameters": {
               "LogGroupName" : { "Fn::GetAtt" : [ "CloudTrailGlobal", "Outputs.CloudWatchLogsLogGroup" ] },
               "Environment" :  {"Ref": "EnvironmentName"}
            },
            "TimeoutInMinutes": "60"
        }
    },
    "IAM": {
        "Type": "AWS::CloudFormation::Stack",
        "DependsOn": ["AWSConfigGlobal", "CloudTrailGlobal" ],
        "Properties": {
            "TemplateURL": { "Fn::Join" : ["", ["https://s3.amazonaws.com/com.ChangeMe.", {"Ref": "EnvironmentName"} , ".cloudform/iam.global.json" ]]},
            "Parameters": {
               "Environment" :  {"Ref": "EnvironmentName"},
               "SQSCloudTrailArn" : { "Fn::GetAtt" : [ "CloudTrailGlobal", "Outputs.SQSCloudTrailArn" ] },
               "SQSAWSConfigArn" : { "Fn::GetAtt" : [ "AWSConfigGlobal", "Outputs.SQSAWSConfigArn" ] }
            },
            "TimeoutInMinutes": "60"
        }
    }
},
"Outputs": {
    "CloudTrailGlobalRef": {
        "Value": { "Ref": "CloudTrailGlobal" }
    },
    "CloudWatchLogsLogGroupARN": {
        "Value": { "Fn::GetAtt": [ "CloudTrailGlobal", "Outputs.CloudWatchLogsLogGroup" ]}
    },
    "SQSAWSConfigName": {
        "Value": { "Fn::GetAtt": [ "AWSConfigGlobal", "Outputs.SQSAWSConfigName" ]}
    }

}
}
